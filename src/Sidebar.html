<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
</head>
<body>
  <div id="app">
    <!-- API Key Setup (shown when not configured) -->
    <div id="setup-section" class="section hidden">
      <h2>Setup Required</h2>
      <div class="info-box">
        Enter your API key to get started. Get one at
        <a href="https://cohort.futuresearch.ai/settings/api-keys" target="_blank">cohort.futuresearch.ai</a>
      </div>
      <label for="api-key-input">API Key</label>
      <input type="password" id="api-key-input" placeholder="sk-cho-...">
      <button class="primary" onclick="saveApiKey()">Save API Key</button>
    </div>

    <!-- Main Interface (shown when configured) -->
    <div id="main-section" class="hidden">
      <!-- Selection Info -->
      <div id="selection-info" class="selection-info">
        <span class="stat">Rows: <span id="row-count" class="stat-value">0</span></span>
        <span class="stat">Columns: <span id="col-count" class="stat-value">0</span></span>
        <button class="secondary" onclick="refreshSelection()" style="float: right; padding: 4px 8px; font-size: 11px;">Refresh</button>
      </div>

      <!-- Operation Tabs -->
      <div class="tabs">
        <div class="tab active" data-tab="rank">Rank</div>
        <div class="tab" data-tab="screen">Screen</div>
        <div class="tab" data-tab="dedupe">Dedupe</div>
      </div>

      <!-- Rank Tab -->
      <div id="rank-tab" class="tab-content active">
        <label for="rank-task">Ranking Task</label>
        <textarea id="rank-task" placeholder="e.g., Rank companies by growth potential based on their description"></textarea>

        <label for="rank-field">Score Field Name</label>
        <input type="text" id="rank-field" value="score" placeholder="score">

        <div class="checkbox-group">
          <input type="checkbox" id="rank-ascending">
          <label for="rank-ascending">Sort ascending (lowest first)</label>
        </div>

        <button class="primary" onclick="runRankOperation()">Run Rank</button>
      </div>

      <!-- Screen Tab -->
      <div id="screen-tab" class="tab-content">
        <label for="screen-task">Screening Criteria</label>
        <textarea id="screen-task" placeholder="e.g., Companies with more than 100 employees that are in the technology sector"></textarea>

        <button class="primary" onclick="runScreenOperation()">Run Screen</button>
      </div>

      <!-- Dedupe Tab -->
      <div id="dedupe-tab" class="tab-content">
        <label for="dedupe-relation">What makes records duplicates?</label>
        <textarea id="dedupe-relation" placeholder="e.g., Same company, possibly with different name variations or typos"></textarea>

        <button class="primary" onclick="runDedupeOperation()">Run Dedupe</button>
      </div>

      <!-- Status Section -->
      <div id="status-section" class="section hidden">
        <div id="status-loading" class="loading hidden">
          <div class="spinner"></div>
          <span id="status-message">Processing...</span>
        </div>
        <div id="status-success" class="success-box hidden"></div>
        <div id="status-error" class="error-box hidden"></div>
      </div>

      <!-- Previous Task Section -->
      <div id="previous-task-section" class="section hidden">
        <h3>Previous Task</h3>
        <div class="info-box">
          A previous task is still running. Task ID: <span id="previous-task-id" class="api-key-display"></span>
        </div>
        <div class="button-group">
          <button class="secondary" onclick="checkPreviousTask()">Check Status</button>
          <button class="secondary" onclick="clearPreviousTask()">Dismiss</button>
        </div>
      </div>

      <!-- Settings Link -->
      <div style="margin-top: 24px; border-top: 1px solid #e0e0e0; padding-top: 16px;">
        <span class="help-link">
          API Key: <span id="api-key-display" class="api-key-display"></span>
          <a href="#" onclick="showApiKeyDialog(); return false;" style="margin-left: 8px;">Change</a>
        </span>
      </div>
    </div>

    <!-- API Key Change Dialog -->
    <div id="api-key-dialog" class="section hidden">
      <h3>Change API Key</h3>
      <label for="new-api-key">New API Key</label>
      <input type="password" id="new-api-key" placeholder="sk-cho-...">
      <div class="button-group">
        <button class="primary" onclick="updateApiKey()">Save</button>
        <button class="secondary" onclick="hideApiKeyDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    // State
    let state = {
      isConfigured: false,
      apiKeyMasked: null,
      lastTaskId: null,
      selectionInfo: { hasSelection: false, rowCount: 0, columnCount: 0, headers: [] }
    };

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      setupTabs();
      loadInitialState();
    });

    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.dataset.tab;
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          this.classList.add('active');
          document.getElementById(tabName + '-tab').classList.add('active');
        });
      });
    }

    function loadInitialState() {
      google.script.run
        .withSuccessHandler(function(data) {
          state = data;
          updateUI();
        })
        .withFailureHandler(showError)
        .getSidebarData();
    }

    function updateUI() {
      // Show/hide sections based on configuration state
      document.getElementById('setup-section').classList.toggle('hidden', state.isConfigured);
      document.getElementById('main-section').classList.toggle('hidden', !state.isConfigured);

      if (state.isConfigured) {
        document.getElementById('api-key-display').textContent = state.apiKeyMasked || '';

        // Update selection info
        document.getElementById('row-count').textContent = state.selectionInfo.rowCount;
        document.getElementById('col-count').textContent = state.selectionInfo.columnCount;

        // Show previous task section if there's a pending task
        const hasPreviousTask = state.lastTaskId !== null;
        document.getElementById('previous-task-section').classList.toggle('hidden', !hasPreviousTask);
        if (hasPreviousTask) {
          document.getElementById('previous-task-id').textContent = state.lastTaskId.substring(0, 8) + '...';
        }
      }
    }

    function refreshSelection() {
      google.script.run
        .withSuccessHandler(function(info) {
          state.selectionInfo = info;
          document.getElementById('row-count').textContent = info.rowCount;
          document.getElementById('col-count').textContent = info.columnCount;
        })
        .withFailureHandler(showError)
        .getSelectionInfo();
    }

    function saveApiKey() {
      const apiKey = document.getElementById('api-key-input').value.trim();
      if (!apiKey) {
        showError({ message: 'Please enter an API key' });
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadInitialState();
          } else {
            showError({ message: result.error });
          }
        })
        .withFailureHandler(showError)
        .saveApiKeyFromSidebar(apiKey);
    }

    function showApiKeyDialog() {
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('api-key-dialog').classList.remove('hidden');
    }

    function hideApiKeyDialog() {
      document.getElementById('api-key-dialog').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
    }

    function updateApiKey() {
      const apiKey = document.getElementById('new-api-key').value.trim();
      if (!apiKey) {
        showError({ message: 'Please enter an API key' });
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            hideApiKeyDialog();
            loadInitialState();
          } else {
            showError({ message: result.error });
          }
        })
        .withFailureHandler(showError)
        .saveApiKeyFromSidebar(apiKey);
    }

    function showLoading(message) {
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-loading').classList.remove('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
      document.getElementById('status-message').textContent = message || 'Processing...';
    }

    function hideLoading() {
      document.getElementById('status-loading').classList.add('hidden');
    }

    function showSuccess(message) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-success').classList.remove('hidden');
      document.getElementById('status-success').textContent = message;
    }

    function showError(error) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-error').classList.remove('hidden');
      document.getElementById('status-error').textContent = error.message || String(error);
    }

    function clearStatus() {
      document.getElementById('status-section').classList.add('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
    }

    function runRankOperation() {
      const task = document.getElementById('rank-task').value.trim();
      if (!task) {
        showError({ message: 'Please enter a ranking task' });
        return;
      }

      const fieldName = document.getElementById('rank-field').value.trim() || 'score';
      const ascending = document.getElementById('rank-ascending').checked;

      clearStatus();
      showLoading('Running rank operation...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runRank(task, fieldName, ascending);
    }

    function runScreenOperation() {
      const task = document.getElementById('screen-task').value.trim();
      if (!task) {
        showError({ message: 'Please enter screening criteria' });
        return;
      }

      clearStatus();
      showLoading('Running screen operation...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runScreen(task);
    }

    function runDedupeOperation() {
      const relation = document.getElementById('dedupe-relation').value.trim();
      if (!relation) {
        showError({ message: 'Please describe what makes records duplicates' });
        return;
      }

      clearStatus();
      showLoading('Running dedupe operation...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runDedupe(relation);
    }

    function handleOperationResult(result) {
      if (result.status === 'completed') {
        showSuccess('Completed! ' + result.rowCount + ' rows written to new sheet.');
        loadInitialState(); // Refresh state
      } else if (result.status === 'timeout') {
        showError({ message: result.message });
        loadInitialState(); // Refresh to show previous task section
      } else {
        showError({ message: 'Unexpected result: ' + JSON.stringify(result) });
      }
    }

    function checkPreviousTask() {
      clearStatus();
      showLoading('Checking task status...');

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.status === 'completed') {
            // Ask if user wants to retrieve results
            if (confirm('Task completed! Write results to a new sheet?')) {
              retrieveResults(result.taskId);
            } else {
              hideLoading();
              loadInitialState();
            }
          } else if (result.status === 'running') {
            showError({ message: result.message });
          }
        })
        .withFailureHandler(showError)
        .checkPreviousTask();
    }

    function retrieveResults(taskId) {
      showLoading('Retrieving results...');

      google.script.run
        .withSuccessHandler(function(result) {
          showSuccess('Results written! ' + result.rowCount + ' rows.');
          loadInitialState();
        })
        .withFailureHandler(showError)
        .retrieveTaskResults(taskId, 'Results');
    }

    function clearPreviousTask() {
      google.script.run
        .withSuccessHandler(function() {
          loadInitialState();
        })
        .withFailureHandler(showError)
        .clearLastTaskId();
    }
  </script>
</body>
</html>
