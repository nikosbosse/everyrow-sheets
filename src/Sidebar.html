<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
</head>
<body>
  <div id="app">
    <!-- Logo -->
    <div style="text-align: center; margin-bottom: 0px;">
      <img src="data:image/png;base64,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" alt="everyrow" style="height: 40px;">
    </div>

    <!-- API Key Setup (shown when not configured) -->
    <div id="setup-section" class="hidden">
      <h2>Welcome to everyrow</h2>
      <p style="color: #5f6368; margin-bottom: 16px;">
        Run AI-powered operations on your spreadsheet data: rank, screen, and deduplicate rows.
      </p>
      <div class="info-box">
        <strong>Get your API key:</strong><br>
        <a href="https://everyrow.io/api-key" target="_blank">everyrow.io/api-key</a>
      </div>
      <label for="api-key-input">API Key</label>
      <input type="password" id="api-key-input" placeholder="sk-cho-...">
      <button class="primary" onclick="saveApiKey()">Save API Key</button>
    </div>

    <!-- Main Interface (shown when configured) -->
    <div id="main-section" class="hidden">

      <!-- Header with help button -->
      <div class="main-header">
        <button class="icon-btn" onclick="showHelpModal()" title="Instructions">?</button>
      </div>

      <!-- Step 1: Choose Operation -->
      <div class="step-section">
        <div class="step-header">
          <span class="step-number">1</span>
          <span class="step-title">Choose operation</span>
        </div>
        <div class="step-content">
          <div class="operation-cards">
            <div class="operation-card" data-operation="rank" onclick="selectOperation('rank')">
              <span class="operation-name">Rank</span> <span class="operation-desc">— Score and sort rows</span>
            </div>
            <div class="operation-card" data-operation="screen" onclick="selectOperation('screen')">
              <span class="operation-name">Screen</span> <span class="operation-desc">— Filter matching rows</span>
            </div>
            <div class="operation-card" data-operation="dedupe" onclick="selectOperation('dedupe')">
              <span class="operation-name">Dedupe</span> <span class="operation-desc">— Remove duplicates</span>
            </div>
            <div class="operation-card" data-operation="merge" onclick="selectOperation('merge')">
              <span class="operation-name">Merge</span> <span class="operation-desc">— Combine two tables</span>
            </div>
            <div class="operation-card" data-operation="agent" onclick="selectOperation('agent')">
              <span class="operation-name">Agent</span> <span class="operation-desc">— AI research per row</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Configure & Run (dynamic based on operation) -->
      <div id="operation-config" class="step-section hidden">
        <div class="step-header">
          <span class="step-number">2</span>
          <span class="step-title" id="config-title">Configure</span>
          <button class="icon-btn small" onclick="refreshSheets()" title="Refresh data">↻</button>
        </div>
        <div class="step-content">
          <!-- Rank Config -->
          <div id="rank-config" class="operation-form hidden">
            <div class="form-field">
              <label for="rank-sheet">Input Sheet</label>
              <select id="rank-sheet" class="sheet-dropdown"></select>
              <div id="rank-sheet-info" class="sheet-info"></div>
            </div>
            <label for="rank-task">What should rows be ranked by?</label>
            <textarea id="rank-task" placeholder="e.g., Rank companies by growth potential based on their description and metrics"></textarea>
            <div class="form-row">
              <div class="form-field">
                <label for="rank-field">Score column name</label>
                <input type="text" id="rank-field" value="score" placeholder="score">
              </div>
              <div class="form-field">
                <label class="checkbox-label">
                  <input type="checkbox" id="rank-ascending">
                  Sort ascending
                </label>
              </div>
            </div>
            <button class="primary" onclick="runRankOperation()">Run Rank</button>
          </div>

          <!-- Screen Config -->
          <div id="screen-config" class="operation-form hidden">
            <div class="form-field">
              <label for="screen-sheet">Input Sheet</label>
              <select id="screen-sheet" class="sheet-dropdown"></select>
              <div id="screen-sheet-info" class="sheet-info"></div>
            </div>
            <label for="screen-task">What criteria should rows match?</label>
            <textarea id="screen-task" placeholder="e.g., Companies with more than 100 employees in the technology sector"></textarea>
            <button class="primary" onclick="runScreenOperation()">Run Screen</button>
          </div>

          <!-- Dedupe Config -->
          <div id="dedupe-config" class="operation-form hidden">
            <div class="form-field">
              <label for="dedupe-sheet">Input Sheet</label>
              <select id="dedupe-sheet" class="sheet-dropdown"></select>
              <div id="dedupe-sheet-info" class="sheet-info"></div>
            </div>
            <label for="dedupe-relation">What makes two rows duplicates?</label>
            <textarea id="dedupe-relation" placeholder="e.g., Same company, possibly with different name spellings or abbreviations"></textarea>
            <button class="primary" onclick="runDedupeOperation()">Run Dedupe</button>
          </div>

          <!-- Agent Config -->
          <div id="agent-config" class="operation-form hidden">
            <div class="form-field">
              <label for="agent-sheet">Input Sheet</label>
              <select id="agent-sheet" class="sheet-dropdown"></select>
              <div id="agent-sheet-info" class="sheet-info"></div>
            </div>
            <label for="agent-task">What should the agent do for each row?</label>
            <textarea id="agent-task" placeholder="e.g., Research this company and find their LinkedIn page, headquarters location, and founding year"></textarea>

            <!-- Collapsible output columns section -->
            <div class="collapsible-section">
              <div class="collapsible-header" onclick="toggleOutputColumns()">
                <span class="collapsible-icon" id="output-columns-icon">▶</span>
                <span>Define output columns</span>
                <span class="collapsible-hint">(optional)</span>
              </div>
              <div id="output-columns-content" class="collapsible-content hidden">
                <div id="output-columns-list">
                  <!-- Column rows will be added here dynamically -->
                </div>
                <button type="button" class="add-column-btn" onclick="addOutputColumn()">+ Add column</button>
              </div>
            </div>

            <button class="primary" onclick="runAgentOperation()">Run Agent</button>
          </div>

          <!-- Merge Config -->
          <div id="merge-config" class="operation-form hidden">
            <div class="form-row">
              <div class="form-field">
                <label for="merge-left-sheet">Left Table</label>
                <select id="merge-left-sheet" class="sheet-dropdown"></select>
                <div id="merge-left-sheet-info" class="sheet-info"></div>
              </div>
              <div class="form-field">
                <label for="merge-right-sheet">Right Table</label>
                <select id="merge-right-sheet" class="sheet-dropdown"></select>
                <div id="merge-right-sheet-info" class="sheet-info"></div>
              </div>
            </div>

            <label for="merge-task">How should the tables be merged?</label>
            <textarea id="merge-task" placeholder="e.g., Match companies from both tables by name, even if spellings differ slightly"></textarea>

            <div class="form-row">
              <div class="form-field">
                <label for="merge-left-col">Match column (Left) - Optional</label>
                <input type="text" id="merge-left-col" placeholder="Auto-detect">
              </div>
              <div class="form-field">
                <label for="merge-right-col">Match column (Right) - Optional</label>
                <input type="text" id="merge-right-col" placeholder="Auto-detect">
              </div>
            </div>

            <button class="primary" onclick="runMergeOperation()">Run Merge</button>
          </div>
        </div>
      </div>

      <!-- Status Section -->
      <div id="status-section" class="hidden">
        <div id="status-loading" class="loading-box hidden">
          <div class="spinner"></div>
          <div class="loading-text">
            <span id="status-message">Processing...</span>
            <span class="loading-hint">This may take a few minutes</span>
          </div>
        </div>
        <div id="status-success" class="success-box hidden"></div>
        <div id="status-error" class="error-box hidden"></div>
      </div>

      <!-- Footer -->
      <div class="sidebar-footer">
        <span class="api-key-info">
          API Key: <span id="api-key-display" class="monospace"></span>
          <a href="#" onclick="showApiKeyDialog(); return false;">Change</a>
        </span>
      </div>
    </div>

    <!-- API Key Change Dialog -->
    <div id="api-key-dialog" class="hidden">
      <h3>Change API Key</h3>
      <label for="new-api-key">New API Key</label>
      <input type="password" id="new-api-key" placeholder="sk-cho-...">
      <div id="dialog-error" class="error-box hidden" style="margin-bottom: 12px;"></div>
      <div class="button-group">
        <button class="primary" onclick="updateApiKey()">Save</button>
        <button class="secondary" onclick="hideApiKeyDialog()">Cancel</button>
      </div>
    </div>

    <!-- Help Modal -->
    <div id="help-modal" class="modal-overlay hidden" onclick="hideHelpModal(event)">
      <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
          <h3 id="help-modal-title">How to use everyrow</h3>
          <button class="modal-close" onclick="hideHelpModal()">&times;</button>
        </div>
        <div class="modal-body">
          <!-- General help (no operation selected) -->
          <div id="help-general">
            <p><strong>Rank</strong> — Score and sort rows based on criteria you describe. Great for prioritizing leads, ranking candidates, or sorting by relevance.</p>
            <p><strong>Screen</strong> — Filter rows that match specific conditions. Use natural language to describe which rows to keep.</p>
            <p><strong>Dedupe</strong> — Find and remove duplicate rows, even when names are spelled differently or data varies slightly.</p>
            <p><strong>Merge</strong> — Combine two tables by matching rows intelligently, even without exact key matches.</p>
            <p><strong>Agent</strong> — Run AI-powered web research on each row. Find LinkedIn profiles, company info, or any data available online.</p>
          </div>
          <!-- Rank help -->
          <div id="help-rank" class="hidden">
            <p>Rank assigns a score to each row based on criteria you describe, then sorts the results.</p>
            <p><strong>Example prompts:</strong></p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Rank companies by growth potential based on their description and funding"</p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Score candidates by relevance to a senior engineering role"</p>
            <p><strong>Options:</strong></p>
            <p>• <em>Score column name</em> — The name of the new column containing scores</p>
            <p>• <em>Sort ascending</em> — Check to put lowest scores first</p>
          </div>
          <!-- Screen help -->
          <div id="help-screen" class="hidden">
            <p>Screen filters your data, keeping only rows that match your criteria. Each row is evaluated and marked as passing or not.</p>
            <p><strong>Example prompts:</strong></p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Companies with more than 100 employees in the technology sector"</p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Candidates with at least 5 years of Python experience"</p>
            <p>Results include a <em>passes_screen</em> column (true/false) and a <em>reason</em> explaining the decision.</p>
          </div>
          <!-- Dedupe help -->
          <div id="help-dedupe" class="hidden">
            <p>Dedupe finds and groups duplicate rows, even when data isn't exactly the same. It uses AI to understand when two rows represent the same entity.</p>
            <p><strong>Example prompts:</strong></p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Same company, possibly with different name spellings or abbreviations"</p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Same person based on name and email, ignoring case differences"</p>
            <p>Results include <em>selected</em> (the canonical row), <em>equivalence_class_id</em>, and <em>equivalence_class_name</em> columns.</p>
          </div>
          <!-- Agent help -->
          <div id="help-agent" class="hidden">
            <p>Agent performs AI-powered web research for each row. It can browse the web, find information, and add new columns with the results.</p>
            <p><strong>Example prompts:</strong></p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Find this company's LinkedIn page, headquarters location, and founding year"</p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Look up the CEO's name and their Twitter handle"</p>
            <p><strong>Define output columns (optional):</strong></p>
            <p>Click to specify exactly which columns to return. For each column, provide a name and type (Text, Number, or Yes/No). If left empty, the agent will determine the output structure automatically.</p>
          </div>
          <!-- Merge help -->
          <div id="help-merge" class="hidden">
            <p>Merge combines two tables by intelligently matching rows, even without exact key matches. It's like a fuzzy VLOOKUP.</p>
            <p><strong>Example prompts:</strong></p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Match companies from both tables by name, even if spellings differ"</p>
            <p style="background: #f8f9fa; padding: 8px; border-radius: 4px; font-style: italic;">"Join on company name, accounting for 'Inc', 'LLC' variations"</p>
            <p><strong>Options:</strong></p>
            <p>• <em>Match column (optional)</em> — Specify which columns to match on, or leave blank for auto-detection</p>
          </div>
          <hr style="margin: 16px 0; border: none; border-top: 1px solid #e0e0e0;">
          <p style="font-size: 12px; color: #5f6368;">Select a sheet from the dropdown, describe your task, and click Run. Results appear in a new sheet tab.</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    var state = {
      isConfigured: false,
      apiKeyMasked: null,
      lastTaskId: null,
      availableSheets: [],
      currentSheet: '',
      selectedOperation: null
    };

    document.addEventListener('DOMContentLoaded', function() {
      loadInitialState();
    });

    function loadInitialState() {
      google.script.run
        .withSuccessHandler(function(data) {
          state = Object.assign(state, data);
          updateUI();
          loadSheets();
        })
        .withFailureHandler(function(error) {
          // Show setup section on error so user sees something
          document.getElementById('setup-section').classList.remove('hidden');
          document.getElementById('main-section').classList.add('hidden');
          console.error('Failed to load sidebar data:', error);
        })
        .getSidebarData();
    }

    function updateUI() {
      document.getElementById('setup-section').classList.toggle('hidden', state.isConfigured);
      document.getElementById('main-section').classList.toggle('hidden', !state.isConfigured);

      if (state.isConfigured) {
        document.getElementById('api-key-display').textContent = state.apiKeyMasked || '';
      }
    }

    function loadSheets() {
      google.script.run
        .withSuccessHandler(function(result) {
          state.availableSheets = result.sheets;
          state.currentSheet = result.currentSheet;
          populateAllSheetDropdowns();
        })
        .withFailureHandler(function(error) {
          console.error('Failed to load sheets:', error);
        })
        .getAvailableSheets();
    }

    function refreshSheets() {
      loadSheets();
    }

    function populateAllSheetDropdowns() {
      var dropdowns = document.querySelectorAll('.sheet-dropdown');
      dropdowns.forEach(function(select) {
        var currentValue = select.value;
        select.innerHTML = '';
        state.availableSheets.forEach(function(sheet) {
          var option = document.createElement('option');
          option.value = sheet.name;
          option.textContent = sheet.name;
          // Default to current sheet if no value was selected
          if (!currentValue && sheet.name === state.currentSheet) {
            option.selected = true;
          } else if (currentValue && sheet.name === currentValue) {
            option.selected = true;
          }
          select.appendChild(option);
        });
      });

      // Update sheet info displays
      updateSheetInfoDisplay('rank');
      updateSheetInfoDisplay('screen');
      updateSheetInfoDisplay('dedupe');
      updateSheetInfoDisplay('agent');
      updateSheetInfoDisplay('merge-left');
      updateSheetInfoDisplay('merge-right');

      // Add change listeners
      setupSheetDropdownListeners();
    }

    function setupSheetDropdownListeners() {
      ['rank', 'screen', 'dedupe', 'agent'].forEach(function(op) {
        var select = document.getElementById(op + '-sheet');
        if (select) {
          select.onchange = function() {
            updateSheetInfoDisplay(op);
          };
        }
      });

      var leftSelect = document.getElementById('merge-left-sheet');
      if (leftSelect) {
        leftSelect.onchange = function() {
          updateSheetInfoDisplay('merge-left');
        };
      }

      var rightSelect = document.getElementById('merge-right-sheet');
      if (rightSelect) {
        rightSelect.onchange = function() {
          updateSheetInfoDisplay('merge-right');
        };
      }
    }

    function updateSheetInfoDisplay(prefix) {
      var select = document.getElementById(prefix + '-sheet');
      var infoEl = document.getElementById(prefix + '-sheet-info');
      if (!select || !infoEl) return;

      var sheetName = select.value;
      if (!sheetName) {
        infoEl.textContent = '';
        return;
      }

      google.script.run
        .withSuccessHandler(function(info) {
          if (info.hasData) {
            infoEl.textContent = info.rowCount + ' rows';
          } else {
            infoEl.textContent = 'No data';
            infoEl.style.color = '#d93025';
          }
        })
        .withFailureHandler(function() {
          infoEl.textContent = '';
        })
        .getSheetInfo(sheetName);
    }

    function selectOperation(op) {
      state.selectedOperation = op;

      // Update card selection
      document.querySelectorAll('.operation-card').forEach(function(card) {
        card.classList.toggle('selected', card.dataset.operation === op);
      });

      // Show config section
      document.getElementById('operation-config').classList.remove('hidden');

      // Hide all operation forms, show selected one
      document.querySelectorAll('.operation-form').forEach(function(form) {
        form.classList.add('hidden');
      });
      document.getElementById(op + '-config').classList.remove('hidden');

      // Update title
      var titles = { rank: 'Configure Rank', screen: 'Configure Screen', dedupe: 'Configure Dedupe', agent: 'Configure Agent', merge: 'Configure Merge' };
      document.getElementById('config-title').textContent = titles[op];

      clearStatus();
    }

    function saveApiKey() {
      var apiKey = document.getElementById('api-key-input').value.trim();
      if (!apiKey) {
        showError({ message: 'Please enter an API key' });
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadInitialState();
          } else {
            showError({ message: result.error });
          }
        })
        .withFailureHandler(showError)
        .saveApiKeyFromSidebar(apiKey);
    }

    function showApiKeyDialog() {
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('api-key-dialog').classList.remove('hidden');
    }

    function hideApiKeyDialog() {
      document.getElementById('api-key-dialog').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
      document.getElementById('new-api-key').value = '';
      hideDialogError();
    }

    function showDialogError(message) {
      var el = document.getElementById('dialog-error');
      el.textContent = message;
      el.classList.remove('hidden');
    }

    function hideDialogError() {
      document.getElementById('dialog-error').classList.add('hidden');
    }

    function showHelpModal() {
      // Hide all help sections
      document.getElementById('help-general').classList.add('hidden');
      document.getElementById('help-rank').classList.add('hidden');
      document.getElementById('help-screen').classList.add('hidden');
      document.getElementById('help-dedupe').classList.add('hidden');
      document.getElementById('help-agent').classList.add('hidden');
      document.getElementById('help-merge').classList.add('hidden');

      // Show appropriate section based on selected operation
      var op = state.selectedOperation;
      var titles = {
        rank: 'How to use Rank',
        screen: 'How to use Screen',
        dedupe: 'How to use Dedupe',
        agent: 'How to use Agent',
        merge: 'How to use Merge'
      };

      if (op && document.getElementById('help-' + op)) {
        document.getElementById('help-' + op).classList.remove('hidden');
        document.getElementById('help-modal-title').textContent = titles[op] || 'Instructions';
      } else {
        document.getElementById('help-general').classList.remove('hidden');
        document.getElementById('help-modal-title').textContent = 'How to use everyrow';
      }

      document.getElementById('help-modal').classList.remove('hidden');
    }

    function hideHelpModal(event) {
      if (!event || event.target === event.currentTarget) {
        document.getElementById('help-modal').classList.add('hidden');
      }
    }

    // Output columns management
    var outputColumnCounter = 0;

    function toggleOutputColumns() {
      var content = document.getElementById('output-columns-content');
      var icon = document.getElementById('output-columns-icon');
      var isHidden = content.classList.contains('hidden');

      content.classList.toggle('hidden');
      icon.textContent = isHidden ? '▼' : '▶';

      // Add first column if expanding and empty
      if (isHidden && document.getElementById('output-columns-list').children.length === 0) {
        addOutputColumn();
      }
    }

    function addOutputColumn() {
      var list = document.getElementById('output-columns-list');
      var id = 'col-' + (++outputColumnCounter);

      var row = document.createElement('div');
      row.className = 'output-column-row';
      row.id = id;
      row.innerHTML =
        '<input type="text" class="column-name-input" placeholder="Column name">' +
        '<select class="column-type-select">' +
          '<option value="string">Text</option>' +
          '<option value="number">Number</option>' +
          '<option value="boolean">Yes/No</option>' +
        '</select>' +
        '<button type="button" class="remove-column-btn" onclick="removeOutputColumn(\'' + id + '\')">&minus;</button>';

      list.appendChild(row);
    }

    function removeOutputColumn(id) {
      var row = document.getElementById(id);
      if (row) {
        row.remove();
      }
    }

    function getOutputSchema() {
      var rows = document.querySelectorAll('#output-columns-list .output-column-row');
      if (rows.length === 0) {
        return null;
      }

      var properties = {};
      var required = [];
      var hasValidColumn = false;

      rows.forEach(function(row) {
        var name = row.querySelector('.column-name-input').value.trim();
        var type = row.querySelector('.column-type-select').value;

        if (name) {
          hasValidColumn = true;
          properties[name] = { type: type };
          required.push(name);
        }
      });

      if (!hasValidColumn) {
        return null;
      }

      return {
        type: 'object',
        properties: properties,
        required: required
      };
    }

    function resetOutputColumns() {
      document.getElementById('output-columns-list').innerHTML = '';
      document.getElementById('output-columns-content').classList.add('hidden');
      document.getElementById('output-columns-icon').textContent = '▶';
      outputColumnCounter = 0;
    }

    function updateApiKey() {
      hideDialogError();
      var apiKey = document.getElementById('new-api-key').value.trim();
      if (!apiKey) {
        showDialogError('Please enter an API key');
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            hideApiKeyDialog();
            clearStatus();
            loadInitialState();
          } else {
            showDialogError(result.error);
          }
        })
        .withFailureHandler(function(error) {
          showDialogError(error.message || String(error));
        })
        .saveApiKeyFromSidebar(apiKey);
    }

    function showLoading(message) {
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-loading').classList.remove('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
      document.getElementById('status-message').textContent = message || 'Processing...';
    }

    function hideLoading() {
      document.getElementById('status-loading').classList.add('hidden');
    }

    function showSuccess(message) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-success').classList.remove('hidden');
      document.getElementById('status-success').innerHTML = message;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showError(error, sessionId) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-error').classList.remove('hidden');
      var message = escapeHtml(error.message || String(error));
      if (sessionId) {
        message += getSessionLink(sessionId);
      }
      document.getElementById('status-error').innerHTML = message;
    }

    function clearStatus() {
      document.getElementById('status-section').classList.add('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
      document.getElementById('status-loading').classList.add('hidden');
    }

    function runRankOperation() {
      var sheetName = document.getElementById('rank-sheet').value;
      if (!sheetName) {
        showError({ message: 'Please select an input sheet' });
        return;
      }

      var task = document.getElementById('rank-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe what to rank by' });
        return;
      }

      var fieldName = document.getElementById('rank-field').value.trim() || 'score';
      var ascending = document.getElementById('rank-ascending').checked;

      clearStatus();
      showLoading('Processing...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runRank(task, fieldName, ascending, sheetName);
    }

    function runScreenOperation() {
      var sheetName = document.getElementById('screen-sheet').value;
      if (!sheetName) {
        showError({ message: 'Please select an input sheet' });
        return;
      }

      var task = document.getElementById('screen-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe the screening criteria' });
        return;
      }

      clearStatus();
      showLoading('Processing...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runScreen(task, sheetName);
    }

    function runDedupeOperation() {
      var sheetName = document.getElementById('dedupe-sheet').value;
      if (!sheetName) {
        showError({ message: 'Please select an input sheet' });
        return;
      }

      var relation = document.getElementById('dedupe-relation').value.trim();
      if (!relation) {
        showError({ message: 'Please describe what makes rows duplicates' });
        return;
      }

      clearStatus();
      showLoading('Processing...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runDedupe(relation, sheetName);
    }

    function runAgentOperation() {
      var sheetName = document.getElementById('agent-sheet').value;
      if (!sheetName) {
        showError({ message: 'Please select an input sheet' });
        return;
      }

      var task = document.getElementById('agent-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe what the agent should do' });
        return;
      }

      var responseSchema = getOutputSchema();

      clearStatus();
      showLoading('Running agent on each row...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runAgentMap(task, sheetName, responseSchema);
    }

    function runMergeOperation() {
      var leftSheetName = document.getElementById('merge-left-sheet').value;
      var rightSheetName = document.getElementById('merge-right-sheet').value;

      if (!leftSheetName) {
        showError({ message: 'Please select a left table sheet' });
        return;
      }
      if (!rightSheetName) {
        showError({ message: 'Please select a right table sheet' });
        return;
      }

      var task = document.getElementById('merge-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe how to merge the tables' });
        return;
      }

      var mergeLeftCol = document.getElementById('merge-left-col').value.trim() || null;
      var mergeRightCol = document.getElementById('merge-right-col').value.trim() || null;

      clearStatus();
      showLoading('Merging tables...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runMerge(leftSheetName, rightSheetName, task, mergeLeftCol, mergeRightCol);
    }

    function getSessionLink(sessionId) {
      if (!sessionId) return '';
      var url = 'https://everyrow.io/sessions/' + sessionId;
      return '<br><a href="' + url + '" target="_blank">View session in Cohort</a>';
    }

    function handleOperationResult(result) {
      var sessionLink = getSessionLink(result.sessionId);
      if (result.status === 'completed') {
        showSuccess('<strong>Done!</strong> ' + result.rowCount + ' rows written to a new sheet tab.' + sessionLink);
        loadInitialState();
      } else if (result.status === 'timeout') {
        showError({ message: result.message }, result.sessionId);
        loadInitialState();
      } else {
        showError({ message: 'Unexpected result: ' + JSON.stringify(result) }, result.sessionId);
      }
    }
  </script>
</body>
</html>
