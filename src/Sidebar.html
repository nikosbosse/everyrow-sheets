<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
</head>
<body>
  <div id="app">
    <!-- API Key Setup (shown when not configured) -->
    <div id="setup-section" class="hidden">
      <h2>Welcome to everyrow</h2>
      <p style="color: #5f6368; margin-bottom: 16px;">
        Run AI-powered operations on your spreadsheet data: rank, screen, and deduplicate rows.
      </p>
      <div class="info-box">
        <strong>Get your API key:</strong><br>
        <a href="https://cohort.futuresearch.ai/settings/api-keys" target="_blank">cohort.futuresearch.ai/settings/api-keys</a>
      </div>
      <label for="api-key-input">API Key</label>
      <input type="password" id="api-key-input" placeholder="sk-cho-...">
      <button class="primary" onclick="saveApiKey()">Save API Key</button>
    </div>

    <!-- Main Interface (shown when configured) -->
    <div id="main-section" class="hidden">

      <!-- Step 1: Data Selection -->
      <div class="step-section">
        <div class="step-header">
          <span class="step-number">1</span>
          <span class="step-title">Select your data</span>
        </div>
        <div class="step-content">
          <p class="step-description">
            Select cells in your sheet including the header row. The first row becomes column names.
          </p>
          <div id="selection-info" class="selection-box">
            <div id="no-selection" class="hidden">
              <span style="color: #d93025;">No selection detected</span>
            </div>
            <div id="has-selection">
              <span><strong id="row-count">0</strong> rows selected</span>
              <span style="margin-left: 12px;"><strong id="col-count">0</strong> columns</span>
            </div>
          </div>
          <button class="secondary small" onclick="refreshSelection()">Refresh Selection</button>
        </div>
      </div>

      <!-- Step 2: Choose Operation -->
      <div class="step-section">
        <div class="step-header">
          <span class="step-number">2</span>
          <span class="step-title">Choose operation</span>
        </div>
        <div class="step-content">
          <div class="operation-cards">
            <div class="operation-card" data-operation="rank" onclick="selectOperation('rank')">
              <div class="operation-name">Rank</div>
              <div class="operation-desc">Score and sort rows by criteria</div>
            </div>
            <div class="operation-card" data-operation="screen" onclick="selectOperation('screen')">
              <div class="operation-name">Screen</div>
              <div class="operation-desc">Filter rows that match conditions</div>
            </div>
            <div class="operation-card" data-operation="dedupe" onclick="selectOperation('dedupe')">
              <div class="operation-name">Dedupe</div>
              <div class="operation-desc">Remove duplicate rows</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Configure & Run (dynamic based on operation) -->
      <div id="operation-config" class="step-section hidden">
        <div class="step-header">
          <span class="step-number">3</span>
          <span class="step-title" id="config-title">Configure</span>
        </div>
        <div class="step-content">
          <!-- Rank Config -->
          <div id="rank-config" class="operation-form hidden">
            <label for="rank-task">What should rows be ranked by?</label>
            <textarea id="rank-task" placeholder="e.g., Rank companies by growth potential based on their description and metrics"></textarea>
            <div class="form-row">
              <div class="form-field">
                <label for="rank-field">Score column name</label>
                <input type="text" id="rank-field" value="score" placeholder="score">
              </div>
              <div class="form-field">
                <label class="checkbox-label">
                  <input type="checkbox" id="rank-ascending">
                  Sort ascending
                </label>
              </div>
            </div>
            <button class="primary" onclick="runRankOperation()">Run Rank</button>
          </div>

          <!-- Screen Config -->
          <div id="screen-config" class="operation-form hidden">
            <label for="screen-task">What criteria should rows match?</label>
            <textarea id="screen-task" placeholder="e.g., Companies with more than 100 employees in the technology sector"></textarea>
            <button class="primary" onclick="runScreenOperation()">Run Screen</button>
          </div>

          <!-- Dedupe Config -->
          <div id="dedupe-config" class="operation-form hidden">
            <label for="dedupe-relation">What makes two rows duplicates?</label>
            <textarea id="dedupe-relation" placeholder="e.g., Same company, possibly with different name spellings or abbreviations"></textarea>
            <button class="primary" onclick="runDedupeOperation()">Run Dedupe</button>
          </div>
        </div>
      </div>

      <!-- Status Section -->
      <div id="status-section" class="hidden">
        <div id="status-loading" class="loading-box hidden">
          <div class="spinner"></div>
          <div class="loading-text">
            <span id="status-message">Processing...</span>
            <span class="loading-hint">This may take a few minutes</span>
          </div>
        </div>
        <div id="status-success" class="success-box hidden"></div>
        <div id="status-error" class="error-box hidden"></div>
      </div>

      <!-- Footer -->
      <div class="sidebar-footer">
        <span class="api-key-info">
          API Key: <span id="api-key-display" class="monospace"></span>
          <a href="#" onclick="showApiKeyDialog(); return false;">Change</a>
        </span>
      </div>
    </div>

    <!-- API Key Change Dialog -->
    <div id="api-key-dialog" class="hidden">
      <h3>Change API Key</h3>
      <label for="new-api-key">New API Key</label>
      <input type="password" id="new-api-key" placeholder="sk-cho-...">
      <div class="button-group">
        <button class="primary" onclick="updateApiKey()">Save</button>
        <button class="secondary" onclick="hideApiKeyDialog()">Cancel</button>
      </div>
    </div>
  </div>

  <script>
    var state = {
      isConfigured: false,
      apiKeyMasked: null,
      lastTaskId: null,
      selectionInfo: { hasSelection: false, rowCount: 0, columnCount: 0, headers: [] },
      selectedOperation: null
    };

    document.addEventListener('DOMContentLoaded', function() {
      loadInitialState();
    });

    function loadInitialState() {
      google.script.run
        .withSuccessHandler(function(data) {
          state = Object.assign(state, data);
          updateUI();
        })
        .withFailureHandler(showError)
        .getSidebarData();
    }

    function updateUI() {
      document.getElementById('setup-section').classList.toggle('hidden', state.isConfigured);
      document.getElementById('main-section').classList.toggle('hidden', !state.isConfigured);

      if (state.isConfigured) {
        document.getElementById('api-key-display').textContent = state.apiKeyMasked || '';
        updateSelectionDisplay();
      }
    }

    function updateSelectionDisplay() {
      var hasData = state.selectionInfo.rowCount > 0;
      document.getElementById('no-selection').classList.toggle('hidden', hasData);
      document.getElementById('has-selection').classList.toggle('hidden', !hasData);
      document.getElementById('row-count').textContent = state.selectionInfo.rowCount;
      document.getElementById('col-count').textContent = state.selectionInfo.columnCount;
    }

    function refreshSelection() {
      google.script.run
        .withSuccessHandler(function(info) {
          state.selectionInfo = info;
          updateSelectionDisplay();
        })
        .withFailureHandler(showError)
        .getSelectionInfo();
    }

    function selectOperation(op) {
      state.selectedOperation = op;

      // Update card selection
      document.querySelectorAll('.operation-card').forEach(function(card) {
        card.classList.toggle('selected', card.dataset.operation === op);
      });

      // Show config section
      document.getElementById('operation-config').classList.remove('hidden');

      // Hide all operation forms, show selected one
      document.querySelectorAll('.operation-form').forEach(function(form) {
        form.classList.add('hidden');
      });
      document.getElementById(op + '-config').classList.remove('hidden');

      // Update title
      var titles = { rank: 'Configure Rank', screen: 'Configure Screen', dedupe: 'Configure Dedupe' };
      document.getElementById('config-title').textContent = titles[op];

      clearStatus();
    }

    function saveApiKey() {
      var apiKey = document.getElementById('api-key-input').value.trim();
      if (!apiKey) {
        showError({ message: 'Please enter an API key' });
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            loadInitialState();
          } else {
            showError({ message: result.error });
          }
        })
        .withFailureHandler(showError)
        .saveApiKeyFromSidebar(apiKey);
    }

    function showApiKeyDialog() {
      document.getElementById('main-section').classList.add('hidden');
      document.getElementById('api-key-dialog').classList.remove('hidden');
    }

    function hideApiKeyDialog() {
      document.getElementById('api-key-dialog').classList.add('hidden');
      document.getElementById('main-section').classList.remove('hidden');
    }

    function updateApiKey() {
      var apiKey = document.getElementById('new-api-key').value.trim();
      if (!apiKey) {
        showError({ message: 'Please enter an API key' });
        return;
      }

      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            hideApiKeyDialog();
            loadInitialState();
          } else {
            showError({ message: result.error });
          }
        })
        .withFailureHandler(showError)
        .saveApiKeyFromSidebar(apiKey);
    }

    function showLoading(message) {
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-loading').classList.remove('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
      document.getElementById('status-message').textContent = message || 'Processing...';
    }

    function hideLoading() {
      document.getElementById('status-loading').classList.add('hidden');
    }

    function showSuccess(message) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-success').classList.remove('hidden');
      document.getElementById('status-success').innerHTML = message;
    }

    function showError(error) {
      hideLoading();
      document.getElementById('status-section').classList.remove('hidden');
      document.getElementById('status-error').classList.remove('hidden');
      document.getElementById('status-error').textContent = error.message || String(error);
    }

    function clearStatus() {
      document.getElementById('status-section').classList.add('hidden');
      document.getElementById('status-success').classList.add('hidden');
      document.getElementById('status-error').classList.add('hidden');
      document.getElementById('status-loading').classList.add('hidden');
    }

    function runRankOperation() {
      var task = document.getElementById('rank-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe what to rank by' });
        return;
      }

      if (state.selectionInfo.rowCount === 0) {
        showError({ message: 'Please select data in your sheet first' });
        return;
      }

      var fieldName = document.getElementById('rank-field').value.trim() || 'score';
      var ascending = document.getElementById('rank-ascending').checked;

      clearStatus();
      showLoading('Creating input data...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runRank(task, fieldName, ascending);
    }

    function runScreenOperation() {
      var task = document.getElementById('screen-task').value.trim();
      if (!task) {
        showError({ message: 'Please describe the screening criteria' });
        return;
      }

      if (state.selectionInfo.rowCount === 0) {
        showError({ message: 'Please select data in your sheet first' });
        return;
      }

      clearStatus();
      showLoading('Creating input data...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runScreen(task);
    }

    function runDedupeOperation() {
      var relation = document.getElementById('dedupe-relation').value.trim();
      if (!relation) {
        showError({ message: 'Please describe what makes rows duplicates' });
        return;
      }

      if (state.selectionInfo.rowCount === 0) {
        showError({ message: 'Please select data in your sheet first' });
        return;
      }

      clearStatus();
      showLoading('Creating input data...');

      google.script.run
        .withSuccessHandler(handleOperationResult)
        .withFailureHandler(showError)
        .runDedupe(relation);
    }

    function handleOperationResult(result) {
      if (result.status === 'completed') {
        showSuccess('<strong>Done!</strong> ' + result.rowCount + ' rows written to a new sheet tab.');
        loadInitialState();
      } else if (result.status === 'timeout') {
        showError({ message: result.message });
        loadInitialState();
      } else {
        showError({ message: 'Unexpected result: ' + JSON.stringify(result) });
      }
    }
  </script>
</body>
</html>
